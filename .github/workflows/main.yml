name: Build Zen Browser Portable

on:
  schedule:
    - cron: '0 2 * * *' # 每天自动运行
  workflow_dispatch: # 允许手动触发

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write # 必须权限

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 1. 寻找并下载 zen.installer.exe
    - name: Find and Download Installer
      id: download
      shell: powershell
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $url = "https://api.github.com/repos/zen-browser/desktop/releases?per_page=5"
        $headers = @{ "Authorization" = "token $env:GH_TOKEN" }
        
        try {
            $releases = Invoke-RestMethod -Uri $url -Method Get -Headers $headers
        } catch {
            Write-Error "API Request Failed: $($_.Exception.Message)"
            exit 1
        }

        $downloadUrl = ""
        $version = ""

        # 精确寻找 zen.installer.exe
        foreach ($release in $releases) {
            foreach ($asset in $release.assets) {
                if ($asset.name -eq "zen.installer.exe") {
                    $downloadUrl = $asset.browser_download_url
                    $version = $release.tag_name
                    break
                }
            }
            if ($downloadUrl) { break }
        }

        if (-not $downloadUrl) {
            Write-Error "Could not find 'zen.installer.exe' in recent releases."
            exit 1
        }

        Write-Host "Target Version: $version"
        Write-Host "Download URL: $downloadUrl"
        
        Invoke-WebRequest -Uri $downloadUrl -OutFile "zen_installer.exe"
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT

    # 2. 解压安装包
    - name: Extract Installer (7-Zip)
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "ZenBrowserPortable\App\ZenBrowser"
        New-Item -ItemType Directory -Force -Path "ZenBrowserPortable\App\AppInfo"
        New-Item -ItemType Directory -Force -Path "ZenBrowserPortable\Data"
        
        7z x "zen_installer.exe" -o"TempExtract" -y
        
        $corePath = "TempExtract\core"
        if (Test-Path $corePath) {
            Move-Item "$corePath\*" "ZenBrowserPortable\App\ZenBrowser"
        } else {
            $zenExe = Get-ChildItem -Path "TempExtract" -Filter "zen.exe" -Recurse | Select-Object -First 1
            if ($zenExe) {
                Move-Item "$($zenExe.DirectoryName)\*" "ZenBrowserPortable\App\ZenBrowser"
            } else {
                Write-Error "Extraction failed: zen.exe not found."
                exit 1
            }
        }

    # 3. 生成策略文件 (禁用内部更新)
    - name: Create Policy to Disable Updates
      shell: powershell
      run: |
        $distDir = "ZenBrowserPortable\App\ZenBrowser\distribution"
        New-Item -ItemType Directory -Force -Path $distDir
        $policyContent = '{ "policies": { "DisableAppUpdate": true, "ManualAppUpdateOnly": true } }'
        Set-Content -Path "$distDir\policies.json" -Value $policyContent

    # 4. 动态修改 appinfo.ini 的版本号
    - name: Update appinfo.ini Version
      shell: powershell
      run: |
        $ver = "${{ steps.download.outputs.VERSION }}"
        
        # 生成纯数字版本号 (例如 1.17.12b -> 1.17.12.0)
        $safeVer = $ver -replace "[^0-9.]", ""
        while (($safeVer.ToCharArray() | Where-Object { $_ -eq '.' }).Count -lt 3) {
            $safeVer += ".0"
        }
        
        Write-Host "Raw Version: $ver"
        Write-Host "Safe Version: $safeVer"
        
        $path = "ZenBrowserPortable\App\AppInfo\appinfo.ini"
        
        (Get-Content "appinfo.ini") -replace "PackageVersion=1.0.0.0", "PackageVersion=$safeVer" `
                                    -replace "DisplayVersion=Latest", "DisplayVersion=$ver" `
                                    | Set-Content "ZenBrowserPortable\App\AppInfo\appinfo.ini"

        # 生成 version.txt
        Set-Content -Path "ZenBrowserPortable\App\AppInfo\version.txt" -Value $ver

    # 5. 编译启动器
    - name: Compile Launcher
      shell: cmd
      run: |
        copy appicon.ico ZenBrowserPortable\App\AppInfo\
        set CSC=%windir%\Microsoft.NET\Framework64\v4.0.30319\csc.exe
        "%CSC%" /target:exe /out:ZenBrowserPortable\ZenBrowserPortable.exe /win32icon:appicon.ico /r:System.Windows.Forms.dll Launcher.cs

    # 6. 设置 PortableApps.com Installer 
    - name: Setup PortableApps.com Installer
      shell: powershell
      run: |
        # === 使用 SourceForge 稳定直链下载 3.9.5 ===
        $toolUrl = "https://downloads.sourceforge.net/portableapps/PortableApps.comInstaller_3.9.5.paf.exe"
        
        Write-Host "Downloading Installer Tool from: $toolUrl"
        Invoke-WebRequest -Uri $toolUrl -OutFile "InstallerTool.exe"
        
        # 解压工具
        7z x "InstallerTool.exe" -o"PAF_Installer" -y

    # 7. 生成 .paf.exe 安装包
    - name: Build .paf.exe Package
      shell: cmd
      run: |
        "PAF_Installer\App\PortableApps.comInstaller\PortableApps.comInstaller.exe" "%CD%\ZenBrowserPortable"

    # 8. 重命名生成的 .paf.exe
    - name: Rename PAF Installer
      shell: powershell
      run: |
        $ver = "${{ steps.download.outputs.VERSION }}"
        $pafFile = Get-ChildItem -Path . -Filter "*.paf.exe" | Select-Object -First 1
        if ($pafFile) {
            $newName = "ZenBrowserPortable_${ver}.paf.exe"
            Rename-Item -Path $pafFile.FullName -NewName $newName
            Write-Host "Renamed $($pafFile.Name) to $newName"
        } else {
            Write-Error "PAF Installer generation failed!"
            exit 1
        }

    # 9. 生成 ZIP 包
    - name: Package to ZIP
      shell: powershell
      run: |
        $ver = "${{ steps.download.outputs.VERSION }}"
        $zipName = "ZenBrowserPortable_${ver}.zip"
        Compress-Archive -Path "ZenBrowserPortable" -DestinationPath $zipName

    # 10. 上传所有文件
    - name: Upload Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.download.outputs.VERSION }}
        name: Zen Browser Portable ${{ steps.download.outputs.VERSION }}
        files: |
          *.zip
          *.paf.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
